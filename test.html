<!DOCTYPE html>
<html ng-app='app'>
<head lang="en">
	<title>test</title>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<!--<script src="bower_components/modernizr/modernizr.js"></script>-->
	<!--<base href="https://developer.mozilla.org/samples/cssref/">-->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="stylesheet" href="bower_components/bootstrap/less/bootstrap.css">
	<link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.css">
	<link rel="stylesheet" href="less/test.css">
	<script src="bower_components/lodash/lodash.js"></script>
	<script src="bower_components/moment/moment.js"></script>
	<script src="bower_components/jquery/dist/jquery.js"></script>
	<script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
	<script src="bower_components/angular/angular.js"></script>
	<script src="bower_components/angular-animate/angular-animate.js"></script>
	<script src="bower_components/restangular/dist/restangular.js"></script>
	<script src="bower_components/angular-ui-router/release/angular-ui-router.js"></script>
	<style>
	</style>
</head>
<body ng-controller="ctrl" class="container-fluid">

<div class="dk-grid" ng-cloak ng-controller="gridCtrl">
	<div class="table-wrapper">
		<div class="no-results" ng-show="noResults">No results</div>
		<table class="table" ng-hide="noResults">
			<thead>
			<th></th>
			<th ng-repeat="header in headers">
				<a href="" ng-click="sort(header.name)">
					{{header.title}}
			<span class="sort-direction">
				<span ng-show="sortKey == '{{header.name}}-up'" class="fa fa-angle-up"></span>
				<span ng-show="sortKey == '{{header.name}}-dn'" class="fa fa-angle-down"></span>
			</span>
				</a>
			</th>
			</thead>
			<tbody>
			<tr ng-repeat="user in users">
				<td>{{user.rownum}}</td>
				<td>{{user.name}}</td>
				<td>{{user.age}}</td>
				<td>{{user.sex}}</td>
				<td>{{moment(user.bday).format('L')}}</td>
			</tr>
			</tbody>
		</table>
	</div>
	<nav ng-show="numPages > 1">
		<ul class="pagination">
			<li ng-class="{disabled: isFirstPage()}">
				<a href="#" ng-click="prevPage()" class="arrow" aria-label="Previous"><span class="fa fa-angle-double-left"></span></a>
			</li>
			<li ng-hide="isFirstRange()">
				<a class="page-range" href="#" ng-click="setPageRange('dn')"><span>...</span></a>
			</li>
			<li ng-repeat="page in pages" ng-class="{active: curPage == page}">
				<a href="#" ng-click="setPage(page)">{{page+1}}</a>
			</li>
			<li ng-hide="isLastRange()">
				<a class="page-range" href="#" ng-click="setPageRange('up')"><span>...</span></a>
			</li>
			<li ng-class="{disabled: isLastPage()}">
				<a href="#" ng-click="nextPage()" class="arrow" aria-label="Previous"><span class="fa fa-angle-double-right"></span></a>
			</li>
		</ul>
		<ul class="pagination">
			<li><a>{{tableInfo}}</a></li>
		</ul>
	</nav>
</div>

<script>
	var app = angular.module('app', ['restangular', 'ui.router', 'ngAnimate']);
	app.config(function (RestangularProvider, $stateProvider, $urlRouterProvider) {
		RestangularProvider.setBaseUrl('http://localhost:3000/api');
	});
	app.run(function ($rootScope) {
		$rootScope.moment = moment;
	})
	app.factory('$userRepo', function($http) {
		var baseUrl = 'http://localhost:3000/api/users';
		var exp = {};

		exp.getAll = function() {
			return $http.get(baseUrl);
		};

		exp.getPage = function(pageNo, pageSize, sortKey) {
			var params = {pageno: pageNo, pagesize: pageSize};
			if(sortKey) {
				var name = sortKey.substring(0, sortKey.indexOf('-'));
				if(sortKey.substr(-2) == 'dn')
					name = '-' + name;
				params.sort = name;
			}
			return $http.get(baseUrl + '/page', {params: params})
				.then(function(resp) {
					return resp.data;
				});
		}

		return exp;
	})

	app.controller('ctrl', function ($scope, $state, $stateParams, Restangular) {


	})

	app.controller('gridCtrl', function ($scope, $userRepo) {
		var mode = 'page';
		$scope.noResults = false;
		$scope.curPage = 0;
		$scope.pageSize = 5;
		var pageRangeSize = 4;
		var numPages = $scope.numPages = 0;
		var allUsers = [];

		var setTableMinHeight = function() {
			var tableMinHeight;
			if($scope.noResults)
				tableMinHeight = 40 + 20 + 2; //margin+padding+border-top
			else
				tableMinHeight = ($scope.pageSize + 1) * 37 + 20;// rows + header * 37, 20 for table margin bottom

			$('.table-wrapper').css('min-height', tableMinHeight + 'px');
		}

		$scope.setPageRange = function(dir, changePage) {
			var calcMaxPage = ($scope.curPage+1)*pageRangeSize;
			var nextMaxPage =  calcMaxPage > numPages? numPages: calcMaxPage;
			if(dir == 'init') {
				$scope.pages = _.range(0, nextMaxPage);
				return;
			}

			var minPage = 0,
				curStartPage = _.first($scope.pages),
				curEndPage = _.last($scope.pages);
			if(dir == 'dn' && curStartPage == minPage || dir == 'up' && curEndPage == numPages)
				return;
			if(dir == 'dn') {
				var newStart = curStartPage - pageRangeSize >=0? curStartPage - pageRangeSize: 0;
				var newEnd = newStart+pageRangeSize <= numPages? newStart+pageRangeSize: numPages;
//				console.log('prevrange', newStart, newEnd, $scope.curPage);
				$scope.pages = _.range(newStart, newEnd);
				if($scope.curPage < newStart || $scope.curPage > newEnd - 1) {
					$scope.curPage = newStart;
					getPage();
				}
			}
			else if(dir == 'up') {
				var newStart = curStartPage + pageRangeSize <= numPages - pageRangeSize? curStartPage + pageRangeSize: numPages - pageRangeSize;
				var newEnd = newStart+pageRangeSize <= numPages? newStart+pageRangeSize: numPages;
//				console.log('nextrange', newStart, newEnd, $scope.curPage);
				$scope.pages = _.range(newStart, newEnd);
				if($scope.curPage < newStart || $scope.curPage > newEnd - 1) {
					$scope.curPage = newStart;
					getPage();
				}
			}

		}

		var mapData = function (data) {
			return data.map(function(v,i) {
				if (v.bday)
					v.bday = new Date(v.bday);
				return v;
			})
		}

		var refresh = function() {
			if(mode == 'all') {
				$userRepo.getAll().then(function (resp) {
					allUsers = mapData(resp.data);

					if (allUsers.length == 0) {
						$scope.noResults = true;
						setTableMinHeight();
					}
					else {
						$scope.noResults = false;
						setTableMinHeight();
						$scope.curPage = 0;
						$scope.sortKey = undefined;
						getPage();
						numPages = $scope.numPages = Math.ceil(allUsers.length / $scope.pageSize);
						$scope.setPageRange('init');
					}
				});
			}
			else {
				getPage(true);
			}
		}

		var getTableInfoString = function(start, end, totalRecords) {
			return '' + (start + 1) + ' - ' + (end > totalRecords? totalRecords: end) + ' of ' + totalRecords;
		}
		var getPage = function(init) {
			var start = $scope.pageSize*$scope.curPage;
			var end = $scope.pageSize*($scope.curPage+1);
			if(mode == 'all') {
				$scope.users = allUsers.slice(start, end);
				$scope.tableInfo = getTableInfoString(start, end, allUsers.length);
			}
			else {
				if(init)
					$scope.sortKey = undefined;

				$userRepo.getPage($scope.curPage + 1, $scope.pageSize, $scope.sortKey).then(function(resp) {
					$scope.users = mapData(resp.data);
					$scope.tableInfo = getTableInfoString(start, end, resp.numRecords);

					if (resp.numRecords == 0) {
						$scope.noResults = true;
						setTableMinHeight();
					}
					else {
						$scope.noResults = false;
						setTableMinHeight();
						if(init)
							$scope.curPage = 0;
						numPages = $scope.numPages = Math.ceil(resp.numRecords / $scope.pageSize);
						if(init)
						 $scope.setPageRange('init');
					}

				})
			}
		};

		var lastSortName, lastSortKey;
		$scope.sort = function (sortName) {
			if (sortName == lastSortName) {
				if (lastSortKey.substr(-3) == '-up') {
					lastSortKey = sortName + '-dn';
					$scope.sortKey = lastSortKey;
				}
				else {
					lastSortKey = sortName + '-up';
					$scope.sortKey = lastSortKey;
				}
			}
			else {
				lastSortName = sortName;
				lastSortKey = sortName + '-up';
				$scope.sortKey = lastSortKey;
			}

			if(mode == 'all') {
				var sortFcn = getSortFcn(sortName == 'bday' ? 'date' : '', $scope.sortKey);
				allUsers.sort(sortFcn)
				$scope.curPage = 0;
				getPage()
				$scope.setPageRange('init');
			}
			else {
				getPage();
			}
		};

		$scope.isFirstPage = function() {
			return $scope.curPage == 0;
		}
		$scope.isLastPage = function() {
			return $scope.curPage == numPages - 1;
		}

		$scope.isFirstRange = function() {
			return _.first($scope.pages) == 0;
		}

		$scope.isLastRange = function() {
			return _.last($scope.pages) == numPages - 1;
		}

		$scope.prevPage = function(){
			if($scope.isFirstPage())
				return;
			var lastCurPage = $scope.curPage;
			$scope.curPage--;
			if(lastCurPage == _.first($scope.pages))
				$scope.setPageRange('dn');
			getPage();
		}
		$scope.nextPage = function(){
			if($scope.isLastPage())
				return;
			var lastCurPage = $scope.curPage;
			$scope.curPage++;// need to set before setPageRange so it can bump pages if needed
			if(lastCurPage == _.last($scope.pages))
				$scope.setPageRange('up');
			getPage();
		}
		$scope.setPage = function(page) {
			if($scope.curPage == page)
				return;
			$scope.curPage = page;
			getPage();
		}


		$scope.headers = [
			{name: 'name', title: 'Name'},
			{name: 'age', title: 'Age'},
			{name: 'sex', title: 'Sex'},
			{name: 'bday', title: 'Birthday'}
		]


		refresh();

	})

	function getSortFcn(type, key) {
		var direction = key.substr(-2) == 'up' ? 'up' : 'dn';
		var prop = key.substring(0, key.length - 3);
		if (type == 'date') {
			if (direction == 'up') {
				return function (a, b) {
					var ap = a['' + prop] ? a[prop].getTime() : 0;
					var bp = b[prop] ? b[prop].getTime() : 0;
					if (ap < bp) return -1;
					if (ap > bp) return 1;
					return 0;
				}
			}
			else {
				return function (a, b) {
					var ap = a['' + prop] ? a[prop].getTime() : 0;
					var bp = b[prop] ? b[prop].getTime() : 0;
					if (ap > bp) return -1;
					if (ap < bp) return 1;
					return 0;
				}
			}
		}
		else {
			if (direction == 'up') {
				return function (a, b) {
					var ap = a[prop];
					var bp = b[prop];
					if (ap < bp) return -1;
					if (ap > bp) return 1;
					return 0;
				}
			}
			else {
				return function (a, b) {
					var ap = a[prop];
					var bp = b[prop];
					if (ap > bp) return -1;
					if (ap < bp) return 1;
					return 0;
				}
			}
		}
	}

</script>
</body>
</html>